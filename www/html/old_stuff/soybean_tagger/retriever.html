<!DOCTYPE html> 
<html>
<head>

	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">

   <!-- jQuery and jQuery UI -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
   <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
   <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
   
   <!-- for draggable to work on mobile -->
   <script src="jquery.ui.touch-punch.js"></script>
   
   <!-- Raphael (for drawing on images) -->
   <script type="text/javascript" src="raphael.min.js"></script>
   <script type="text/javascript" src="raphael.export.js"></script>    
   
    <!-- CanVG (for putting svg into a canvas) -->
    <script type="text/javascript" src="https://canvg.github.io/canvg/rgbcolor.js"></script> 
	<script type="text/javascript" src="https://canvg.github.io/canvg/StackBlur.js"></script>
	<script type="text/javascript" src="https://canvg.github.io/canvg/canvg.js"></script> 
	
	<!-- Actual application code -->
	<!--script type="text/javascript" src='soybean-tagger.js'></script-->
	
	<!-- My styling -->
	<link rel='stylesheet' href='style.css'>
	
	<script>
		//var paper;
		var BASE_PATH = "https://baskar-group.me.iastate.edu/soybean_tagger/api/";
		var endpoint = "getOutput.php";
		
		var DEFAULT_COLORS = [
			"#800080",
			"#00FFFF",
			"#2222EE",
			"#74BAEC",
			"#FF00FF",
			"#CE93D8",
			"#FD8012",
			"#9A5656",
			"#57504B"
		];
		
		function get(name){
		   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
			  return decodeURIComponent(name[1]);
		}
		
		$(function() {
		
			var author = get("author");
			if(!author){
				alert("Invalid URL - no author specified");
				return;
			}
			alert(author);
			
			//$("#go").click(function() {
				var markedId = $("#mark_id").val();
				
				var url = BASE_PATH + endpoint;
				var dataToSend = { author: author };
				$.ajax({
					url: url,
					type: 'GET',
					data: dataToSend,
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					async: true,
					success: function(responses) {
						
						for(var r=0; r<responses.length; r++){
							var response = responses[r];
							
							console.log(response);
					
							var originalId = response.image_id;
							var image_url = BASE_PATH + "getImage.php?id=" + originalId;
							console.log(image_url);
							
							var tr = $("tr");
							
							var tdImg = $("td");
							$("img", {
								src: url
							}).appendTo(tdImg);
							tdImg.appendTo(tr);
							
							var id = "canvas" + r;
							$("<div>", {
								id: id,
								width: 512,
								height: 512
							}).appendTo(tr);
							
							$("<button>", {
								text: "Re-mark this image"
							}).appendTo(tr);
							
							tr.appendTo("#table");
							
							var paper = Raphael(id, 512,512);
							paper.image(image_url, 0, 0, 512, 512);
							
							console.log(JSON.stringify(response.severities));
							
							var color = -1;
							
							if(response.path && response.path.length > 2){
								var path = JSON.parse(response.path);
								for (var property in path) {
									if (path.hasOwnProperty(property)) {
										color++;
										var pathsArray = path[property];
										
										for(var i=0; i<pathsArray.length; i++){
											paper.path(pathsArray[i]).attr({stroke: DEFAULT_COLORS[color], 'stroke-width': 2});
										}
									}
								}
							}
						}
						
					},
					error: function(msg){
						alert(JSON.stringify(msg));
					}
				});
			
			//});
			
			
		});
		</script>
 
 	<title>Image Tagger</title>
</head>

<body>
	<div id='header'>
		<span id='siteTitle'>Image Tagger</span>
		&nbsp;&nbsp;&nbsp;
		<a href='instructions.html' target=new>Instructions</a>
		
		<span style='float: right;' id='usernameDisplay'></span>
	</div>
	
	<hr />
	
	<div id='wrapper'>
		<table id='table'>
		
		</table>
	</div>
	
</body>

</html>
