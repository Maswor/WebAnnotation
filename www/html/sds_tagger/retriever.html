<!DOCTYPE html>
<html>

<head>

  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">

  <!-- jQuery and jQuery UI -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <!-- for draggable to work on mobile -->
  <script src="jquery.ui.touch-punch.js"></script>

  <!-- Raphael (for drawing on images) -->
  <script type="text/javascript" src="raphael.min.js"></script>
  <script type="text/javascript" src="raphael.export.js"></script>

  <!-- CanVG (for putting svg into a canvas) -->
  <script type="text/javascript" src="https://canvg.github.io/canvg/rgbcolor.js"></script>
  <script type="text/javascript" src="https://canvg.github.io/canvg/StackBlur.js"></script>
  <script type="text/javascript" src="https://canvg.github.io/canvg/canvg.js"></script>

  <!-- Actual application code -->
  <!--script type="text/javascript" src='soybean-tagger.js'></script-->

  <!-- My styling -->
  <link rel='stylesheet' href='style.css'>

  <style>
    #table td .originalImg {
      width: 512px;
      height: 512px;
      display: block;
    }

    #table td {}

  </style>

  <script>
    //var paper;
    var BASE_PATH = "api/";
    var GET_DATA_ENDPOINT = "getOutput.php";
    var GET_DISEASES_ENDPOINT = "getDiseases.php";

    var DEFAULT_COLORS = [
      "#800080",
      "#00FFFF",
      "#2222EE",
      "#74BAEC",
      "#FF00FF",
      "#CE93D8",
      "#FD8012",
      "#9A5656",
      "#57504B"
    ];

    var diseases = [];

    var username;

    function get(name) {
      if (name = (new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)'))
        .exec(location.search))
        return decodeURIComponent(name[1]);
    }

    $(function () {

      var author = get("author");
      if (!author) {
        alert("Invalid URL - no author specified");
        return;
      }

      username = author;
      getDiseases();
    });

    function getDiseases() {

      var url = BASE_PATH + GET_DISEASES_ENDPOINT;
      $.ajax({
        url: url,
        type: 'GET',
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        async: true,
        success: function (response) {

          for (var i = 0; i < response.length; i++) {
            diseases.push({
              id: response[i].id,
              name: response[i].name,
              color: DEFAULT_COLORS[i]
            });
          }

          getImagesForAuthor();
        },
        error: function (msg) {
          alert(msg);
        }
      });

    }

    function getImagesForAuthor() {
      var markedId = $("#mark_id")
        .val();

      var url = BASE_PATH + GET_DATA_ENDPOINT;
      var dataToSend = {
        author: username
      };
      $.ajax({
        url: url,
        type: 'GET',
        data: dataToSend,
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        async: true,
        success: function (responses) {

          for (var r = 0; r < responses.length; r++) {
            var response = responses[r];

            console.log(response);

            addToTable(response, r);
          }

        },
        error: function (msg) {
          alert(JSON.stringify(msg));
        }
      });
    }

    function addToTable(response, index) {
      var originalId = response.image_id;
      var image_url = BASE_PATH + "getImage.php?id=" + originalId;
      //console.log(image_url);

      var tr = $("<tr>");

      /*
      var tdImg = $("<td>", {
      	width: 512,
      	height: 512
      });
      $("<img>", {
      	src: image_url,
      	class: "originalImg"
      }).appendTo(tdImg);
      tdImg.appendTo(tr);*/

      var tdMarked = $("<td>", {
        witdh: 512,
        height: 512
      });
      var id = "canvas" + index;
      $("<div>", {
          id: id,
          width: 512,
          height: 512
        })
        .appendTo(tdMarked);
      tdMarked.appendTo(tr);

      var btnTd = $("<td>");
      var link = $("<a>", {
          href: "soybean-tagger.html?remark_id=" + originalId + "&author=" + username
        })
        .appendTo(btnTd);

      $("<button>", {
          text: "Re-mark this image"
        })
        .appendTo(link);
      btnTd.appendTo(tr);

      var inlineBtnTd = $("<td>");
      var inlineBtn = $("<button>", {
        text: "Remark inline"
      });

      inlineBtn.click(function () {
        var trWrapper = $("<tr>", {
          //height: '1000px'
        });

        /*var closeBtn = $("<button>", {
        	text: "Close"
        });
        var closeBtnTd = $("<td>");
        closeBtn.appendTo(closeBtnTd);
        closeBtnTd.appendTo(trWrapper);*/

        var iframe = $("<iframe>", {
          src: "soybean-tagger.html?remark_id=" + originalId + "&author=" + username,
          width: '100%',
          height: '100%'
        });
        var iframeTd = $("<td>", {
          colspan: 3,
          height: '1000px'
        });
        iframe.appendTo(iframeTd);

        //closeBtn.click(function() {
        //	trWrapper.remove();
        //});

        iframeTd.appendTo(trWrapper);
        tr.after(trWrapper);

        inlineBtn.html('Close re-mark window');
        inlineBtn.unbind('click');
        inlineBtn.click(function () {
          trWrapper.remove();
        });
      });
      inlineBtn.appendTo(inlineBtnTd);
      inlineBtnTd.appendTo(tr);

      tr.appendTo("#table");

      var paper = Raphael(id, 512, 512);
      paper.image(image_url, 0, 0, 512, 512);

      console.log(JSON.stringify(response.severities));

      if (response.path && response.path.length > 2) {
        var path = JSON.parse(response.path);
        for (var property in path) {
          if (path.hasOwnProperty(property)) {
            var pathsArray = path[property];
            var color = colorForDisease(property);

            for (var i = 0; i < pathsArray.length; i++) {

              paper.path(pathsArray[i])
                .attr({
                  stroke: color,
                  'stroke-width': 2
                });
            }
          }
        }
      }
    }

    function colorForDisease(disease) {
      for (var i = 0; i < diseases.length; i++) {
        if (diseases[i].id == disease) {
          return diseases[i].color;
        }
      }
      return diseases[diseases.length - 1].color;
    }

  </script>

  <title>Image Tagger</title>
</head>

<body>
  <div id='header'>
    <span id='siteTitle'>Image Tagger</span> &nbsp;&nbsp;&nbsp;
    <a href='instructions.html' target=new>Instructions</a> &nbsp;&nbsp;&nbsp;
    <a href='index.html' target=new>Back to Main Site</a>

    <span style='float: right;' id='usernameDisplay'></span>
  </div>

  <hr />

  <div id='wrapper'>
    <table id='table' width=100%>

    </table>
  </div>

</body>

</html>
