<!DOCTYPE html> 
<html>
<head>

	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">

   <!-- jQuery and jQuery UI -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
   <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
   <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
   
   <!-- for draggable to work on mobile -->
   <script src="jquery.ui.touch-punch.js"></script>
   
   <!-- Raphael (for drawing on images) -->
   <script type="text/javascript" src="raphael.min.js"></script>
   <script type="text/javascript" src="raphael.export.js"></script>    
   
    <!-- CanVG (for putting svg into a canvas) -->
    <script type="text/javascript" src="https://canvg.github.io/canvg/rgbcolor.js"></script> 
	<script type="text/javascript" src="https://canvg.github.io/canvg/StackBlur.js"></script>
	<script type="text/javascript" src="https://canvg.github.io/canvg/canvg.js"></script> 
	
	<!-- Actual application code -->
	<!--script type="text/javascript" src='soybean-tagger.js'></script-->
	
	<!-- My styling -->
	<link rel='stylesheet' href='style.css'>
	
	<script>
		var paper;
		var BASE_PATH = "https://baskar-group.me.iastate.edu/soybean_app/corn_tagger/api/";
		var endpoint = "getOutput.php";
		
		var DEFAULT_COLORS = [
			"#800080",
			"#00FFFF",
			"#2222EE",
			"#74BAEC",
			"#FF00FF",
			"#CE93D8",
			"#FD8012",
			"#9A5656",
			"#57504B"
		];
		
		$(function() {
			
			//$("#go").click(function() {
				//var markedId = $("#mark_id").val();
				
				var url = BASE_PATH + endpoint;
				//var dataToSend = { mark_id: markedId };
				$.ajax({
					url: url,
					type: 'GET',
					//data: dataToSend,
					contentType: 'application/json; charset=utf-8',
					dataType: 'json',
					async: true,
					success: function(responses) {
					
						//console.log(responses);
					
						for(var r=0; r<responses.length; r++){
							var response = responses[r];
							//console.log(response);
							var originalId = response.image_id;
							var image_url = BASE_PATH + "getImage.php?id=" + originalId;
							//console.log(image_url);
							
							var id = "canvas" + r;
							$("<div>", {
								id: id,
								width: 512,
								height: 512
							}).appendTo("#wrapper");
							
							$("#wrapper").append("<br>");
							
							$("<button>", {
								text: "Download coordinates"
							}).click(function() {
								var content = response.path;
			
								var dataUrl = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
								var name = response.mark_id + ".json";
								forceDownload(dataUrl, name);
								
							}).appendTo("#wrapper");
							
							paper = Raphael(id, 512,512);
							paper.image(image_url, 0, 0, 512, 512);
							
							//console.log(response.path);
							if(response.path.length > 2){
								var path = JSON.parse(response.path);
								
								//console.log(JSON.stringify(response.severities));
								
								for (var p=0; p<path.length; p++) {
									paper.path(path[p]).attr({stroke: "#800080", 'stroke-width': 2});
								}
							}
						}
					},
					error: function(msg){
						alert(JSON.stringify(msg));
					}
				});
			
			//});
			
			
		});
		
		/*
		 Goes over data in the paths object 
		 Grabs all data associated with each disease, formats it, 
		  and puts it into another JSON object without
		  the pathObj info (just path points data)
		 Encodes content into a format for downloading,
		 then forces the download of the JSON file 
		*/
		function createAndDownloadJSON(){
			var contentObj = {}
			
			$("#idList li").each(function() {
				var key = this.id;
				
				if(key === "Healthy")
					//Returning false just breaks from the each loop, 
					//doesn't return from 'createAndDownloadJSON'
					return false; 
				
				var value = paths[key];
				if(value.length > 0){
					contentObj[key] = [];
					for(var i=0; i<value.length; i++){
						contentObj[key].push(value[i].pathArr);
					}
				}
			});
			
			var content = JSON.stringify(contentObj);
			
			var dataUrl = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
			var extension = ".json";
			forceDownload(dataUrl, extension);
		}
		
		/*
			When the user presses 'Save', a text file and image file 
			should be downloaded. This function forces the given dataUrl to
			be downloaded, so that the user doesn't have to click 2 download buttons
		*/
		function forceDownload(dataUrl, filename) {
			var a = document.createElement('a');
			a.setAttribute('href', dataUrl);
			a.setAttribute('download', filename);

			if (document.createEvent) {
				var event = document.createEvent('MouseEvents');
				event.initEvent('click', true, true);
				a.dispatchEvent(event);
			}
			else {
				a.click();
			}
		}
		
		</script>
 
 	<title>Marked Images</title>
</head>

<body>
	<!--input id='mark_id' type='text'>
	<input type='button' id='go' value='Go'-->
	<div id='header'>
		<span id='siteTitle'>Image Tagger</span>
		&nbsp;&nbsp;&nbsp;
		<a href='soybean-tagger.html'>Main site</a>
		
		<span style='float: right;' id='usernameDisplay'></span>
		
	</div>
	
	<hr />
	
	<div id="wrapper">
		<!--div width=512 height=512 id="canvas"-->  
	</div>
		
	</div>
	
</body>

</html>
